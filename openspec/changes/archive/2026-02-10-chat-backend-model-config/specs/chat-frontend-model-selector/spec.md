# Spec: 前端双层模型选择器

本文档定义前端双层模型选择器组件的需求规范。

## ADDED Requirements

### Requirement: 双层选择器必须支持模型配置和具体模型的组合选择

组件必须提供两层选择：第一层选择模型配置，第二层选择该配置下的具体模型。选择器必须清晰展示每个模型的能力标签（视觉、思考）。

**Rationale**: 双层选择器让用户可以方便地在不同配置和模型之间切换，同时保持 UI 的清晰性和易用性。

#### Scenario: 初始状态显示默认选项

- **WHEN** 组件首次加载时
- **THEN** 系统必须加载所有启用的模型配置
- **AND** 第一个下拉框必须显示 "请选择模型配置" 提示
- **AND** 第二个下拉框必须显示为禁用状态
- **AND** 第二个下拉框必须显示 "请先选择配置" 提示

#### Scenario: 选择模型配置后显示模型列表

- **WHEN** 用户在第一个下拉框中选择一个模型配置
- **THEN** 第二个下拉框必须启用
- **AND** 第二个下拉框必须显示该配置下的所有模型
- **AND** 每个模型选项必须显示模型 ID
- **AND** 每个模型选项必须显示能力标签（视觉、思考）
- **AND** 如果模型有特殊能力，必须显示对应颜色的标签

#### Scenario: 切换模型配置时更新模型列表

- **WHEN** 用户在第一个下拉框中切换到不同的模型配置
- **THEN** 第二个下拉框必须更新为新配置的模型列表
- **AND** 第二个下拉框的选中状态必须重置
- **AND** 第二个下拉框必须显示提示 "请选择模型"

#### Scenario: 选择模型后触发变更事件

- **WHEN** 用户在第二个下拉框中选择一个模型
- **THEN** 组件必须触发 `change` 事件
- **AND** 事件必须包含 `model_config_id` 和 `model_id` 两个字段
- **AND** 父组件必须能够接收到这两个值

---

### Requirement: 选择器必须支持 localStorage 持久化

组件必须将用户的选择保存到 localStorage，以便在页面刷新后恢复用户的选择。

**Rationale**: 提升用户体验，避免用户每次刷新页面后都需要重新选择模型。

#### Scenario: 保存选择到 localStorage

- **WHEN** 用户选择了一个模型配置和模型
- **THEN** 系统必须将 `model_config_id` 和 `model_id` 保存到 localStorage
- **AND** 保存的键名必须为 `chat_model_selection`

#### Scenario: 从 localStorage 恢复选择

- **WHEN** 组件首次加载时
- **THEN** 系统必须从 localStorage 读取保存的选择
- **AND** 如果保存的 `model_config_id` 存在且有效，第一层下拉框必须自动选中该配置
- **AND** 如果保存的 `model_id` 存在且有效，第二层下拉框必须自动选中该模型
- **AND** 系统必须触发 `change` 事件，通知父组件恢复的选择

#### Scenario: 保存的选择无效时的处理

- **GIVEN** localStorage 中保存了 `model_config_id = 1` 和 `model_id = "gpt-4"`
- **AND** 该配置已被删除或禁用
- **WHEN** 组件首次加载时
- **THEN** 系统必须忽略保存的 `model_config_id`
- **AND** 系统必须显示初始状态（未选择任何配置）
- **AND** 系统必须清除 localStorage 中的无效数据

#### Scenario: 保存的模型 ID 不在配置中时的处理

- **GIVEN** localStorage 中保存了 `model_config_id = 1` 和 `model_id = "gpt-4"`
- **AND** 该配置存在但 "gpt-4" 不在其模型列表中
- **WHEN** 组件首次加载时
- **THEN** 第一层下拉框必须自动选中配置 1
- **AND** 第二层下拉框必须显示该配置的模型列表
- **AND** 第二层下拉框不得自动选中任何模型
- **AND** 系统必须更新 localStorage，移除无效的 `model_id`

---

### Requirement: 选择器必须显示配置和模型的详细信息

组件必须在下拉选项中显示足够的信息，帮助用户做出正确的选择。

**Rationale**: 提供清晰的信息展示，提升用户体验和选择准确性。

#### Scenario: 模型配置选项的显示格式

- **WHEN** 第一个下拉框显示配置选项时
- **THEN** 每个选项必须显示配置名称
- **AND** 每个选项必须显示该配置包含的模型数量，格式为 "配置名 (N models)"
- **AND** 选项必须按配置名称字母顺序排序

#### Scenario: 模型选项的显示格式

- **WHEN** 第二个下拉框显示模型选项时
- **THEN** 每个选项必须显示模型 ID
- **AND** 如果模型支持视觉能力，必须显示绿色的 "视觉" 标签
- **AND** 如果模型支持思考能力，必须显示橙色的 "思考" 标签
- **AND** 如果模型两者都不支持，必须显示灰色的 "无特殊能力" 标签
- **AND** 选项必须按在配置中的顺序显示

---

### Requirement: 选择器必须处理加载和错误状态

组件必须在加载数据时显示加载状态，在出现错误时显示错误信息。

**Rationale**: 提供良好的用户反馈，让用户了解当前状态。

#### Scenario: 加载模型配置列表时显示加载状态

- **WHEN** 组件正在从 API 加载模型配置列表
- **THEN** 第一个下拉框必须显示为禁用状态
- **AND** 第一个下拉框必须显示 "加载中..." 提示

#### Scenario: API 请求失败时显示错误信息

- **WHEN** API 请求失败（网络错误、服务器错误等）
- **THEN** 组件必须显示错误提示消息
- **AND** 错误消息必须说明失败原因
- **AND** 错误消息必须提供 "重试" 按钮
- **WHEN** 用户点击 "重试" 按钮
- **THEN** 系统必须重新发起 API 请求

#### Scenario: 没有可用的模型配置时显示提示

- **WHEN** API 返回的模型配置列表为空
- **THEN** 组件必须显示 "没有可用的模型配置" 提示
- **AND** 组件必须提供 "前往配置管理" 的链接按钮

---

### Requirement: 选择器必须支持响应式设计

组件必须在移动设备和桌面设备上都能良好显示。

**Rationale**: 支持多设备访问，提升用户体验。

#### Scenario: 移动设备上的显示

- **WHEN** 组件在移动设备（宽度 < 768px）上显示
- **THEN** 两个下拉框必须垂直排列
- **AND** 每个下拉框必须占据全宽
- **AND** 下拉框之间必须有适当的间距

#### Scenario: 桌面设备上的显示

- **WHEN** 组件在桌面设备（宽度 >= 768px）上显示
- **THEN** 两个下拉框必须水平排列
- **AND** 下拉框之间必须有适当的间距
- **AND** 布局必须紧凑且清晰

---

### Requirement: 选择器必须集成到 ChatAnalysis 页面

ChatAnalysis 页面必须集成双层模型选择器，并在发送聊天请求时传递 `model_config_id` 和 `model_id`。

**Rationale**: 完成前后端集成，实现模型选择功能。

#### Scenario: ChatAnalysis 页面加载时显示选择器

- **WHEN** 用户访问 ChatAnalysis 页面
- **THEN** 页面必须在聊天输入框上方显示双层模型选择器
- **AND** 选择器必须默认显示恢复的模型选择（如果有）

#### Scenario: 发送聊天请求时传递模型参数

- **WHEN** 用户点击发送按钮
- **THEN** 系统必须从选择器获取 `model_config_id` 和 `model_id`
- **AND** 系统必须将这两个参数包含在聊天请求中
- **AND** 如果用户未选择模型，系统必须显示错误提示

#### Scenario: 模型选择变更时更新 localStorage

- **WHEN** 用户在选择器中更改了模型选择
- **THEN** 系统必须将新的选择保存到 localStorage
- **AND** 系统必须更新后续聊天请求使用的模型
- **AND** 系统不得影响当前会话的历史记录

---

### Requirement: 选择器组件必须可复用

双层模型选择器必须设计为通用组件，可以在其他页面中复用。

**Rationale**: 提高代码复用性，为未来需求做准备。

#### Scenario: 组件 Props 设计

- **WHEN** 其他组件使用双层模型选择器
- **THEN** 组件必须接受以下 Props：
  - `model_config_id?: number` - 可选的初始配置 ID
  - `model_id?: string` - 可选的初始模型 ID
  - `autoSelect?: boolean` - 是否自动选择第一个配置和模型（默认 false）
- **AND** 组件必须触发 `change` 事件，包含 `model_config_id` 和 `model_id`

#### Scenario: 在其他页面中使用

- **WHEN** 其他页面（如设置页面）需要使用模型选择器
- **THEN** 可以直接导入 `DualModelSelector` 组件
- **AND** 可以通过 Props 传入初始值
- **AND** 可以监听 `change` 事件获取用户的选择
